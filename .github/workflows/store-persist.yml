name: Store CRUD Runner (git persistence)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'create|read|update|delete|list'
        required: true
        default: 'list'
      id:
        required: false
        default: ''
      name:
        required: false
        default: ''
      email:
        required: false
        default: ''

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (fetch all history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Ensure store folders exist
        run: |
          mkdir -p ./store
          mkdir -p ./data/store

      - name: Restore persisted store from branch (store-data)
        id: restore
        run: |
          set -euo pipefail
          # Try to fetch the store-data branch; if exists, copy its data into ./store
          git fetch origin store-data || true
          if git show origin/store-data:./data/store >/dev/null 2>&1; then
            echo "store-data branch exists — restoring files"
            # Checkout the tree from the remote branch into working tree
            git checkout origin/store-data -- data/store || true
            cp -r data/store/* ./store/ 2>/dev/null || true
          else
            echo "store-data branch not found — starting with empty store/"
          fi
          echo "After restore, ./store contains:"
          ls -la ./store || true

      - name: Make script executable
        run: chmod +x ./store_crud.sh || true

      - name: Run CRUD Operation
        env:
          ACTION: ${{ github.event.inputs.action }}
          ID: ${{ github.event.inputs.id }}
          NAME: ${{ github.event.inputs.name }}
          EMAIL: ${{ github.event.inputs.email }}
        run: |
          set -euo pipefail
          echo "Action: $ACTION"
          case "$ACTION" in
            create) ./store_crud.sh create --name "$NAME" --email "$EMAIL" ;;
            read)   ./store_crud.sh read "$ID" ;;
            update) ./store_crud.sh update "$ID" --name "$NAME" --email "$EMAIL" ;;
            delete) ./store_crud.sh delete "$ID" ;;
            list)   ./store_crud.sh list ;;
            *) echo "Unknown action: $ACTION" && exit 1 ;;
          esac
          echo "After action — ./store now contains:"
          ls -la ./store || true

      - name: Persist store files to store-data branch (if changed)
        id: persist
        run: |
          set -euo pipefail

          # copy store files into data/store
          rm -rf data/store
          mkdir -p data/store
          shopt -s nullglob || true
          cp ./store/*.txt data/store/ 2>/dev/null || true
          echo "Data prepared for commit:"
          ls -la data/store || true

          # Configure git for the action
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # If store-data branch exists, check it out; otherwise create it
          if git ls-remote --exit-code --heads origin store-data; then
            git checkout store-data
          else
            git checkout -b store-data
          fi

          # Replace data/store with current content
          mkdir -p data
          rm -rf data/store || true
          mkdir -p data/store
          cp -r ./store/*.txt data/store/ 2>/dev/null || true
          git add -A data/store || true

          # Commit & push only if changes present
          if git diff --cached --quiet; then
            echo "No changes to persist."
            echo "pushed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Persist store data from workflow run: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push origin store-data --force
            echo "pushed=true" >> $GITHUB_OUTPUT
          fi

      - name: Show final status
        run: |
          echo "Persist pushed: ${{ steps.persist.outputs.pushed || 'false' }}"
          echo "Contents of data/store on workflow workspace:"
          ls -la data/store || true
